# Amplicon downstream analysis in R (16S / ITS)

This repository contains a set of **R scripts** for downstream analysis of **amplicon sequencing data** (16S and ITS).  
Inputs are generated using the **[Raw-to-Rawr-SLURM](https://github.com/AdamOss88/Raw-to-Rawr-SLURM)** pipeline, adapted to the **Picasso supercomputer (University of Málaga)**, running under SLURM.  



## Input Data Requirements

All input files must be placed in the **`data/`** folder:

- **`otu_table.RDS`** — ASV/OTU abundance table generated by *DADA2*.  
- **`tax_table.RDS`** — Taxonomy assignments (**SILVA** for 16S, **UNITE** for ITS).  
- **`metadata.csv`** — Sample metadata.  
- **`refseq.fasta`** — Reference ASV sequences in FASTA format.  

These files are expected to originate from the **Raw-to-Rawr-SLURM** repository.  



##  Scripts Description

### **01_phyloseq_object_and_clean.R**
- Builds a cleaned **phyloseq** object using counts, taxonomy, metadata, and sequences.  
- Performs marker-specific filtering (*removes chloroplast/mitochondria*).  
- **Output:** `data/soil_16S_clean.rds`  

### **02_summary_ASV_table.R**
- Aggregates abundances at **Phylum** and **Family** levels.  
- Computes relative abundances, means, and standard deviations by *Management* and *Sampling.time*.  
- **Output:** `results/Phylum_summary.xlsx`, `results/Family_summary.xlsx`  

### **03_alpha_diversity.R**
- Calculates **Observed**, **Shannon**, **Simpson**, and **Inverse Simpson** indices.  
- Generates **boxplots** and performs **Wilcoxon**, **Kruskal–Wallis**, and **pairwise Wilcoxon tests** (*FDR-corrected*).  
- **Output:** Excel summaries and PDF figures.  

### **04_beta_diversity.R**
- Applies **Hellinger transformation** and computes **Bray–Curtis distances**.  
- Tests **homogeneity of dispersions (PERMDISP)**.  
- Performs **PERMANOVA** (management, sampling time, interaction).  
- Generates **PCoA plots** with ellipses.  
- **Output:** distance metrics and figures in `results/`.  

### **05_dbRDA.R**
- Assesses the effects of **soil properties** on **community composition**.  
- Evaluates **multicollinearity among soil variables** using **Variance Inflation Factors (VIF)**.  
- Reduces soil variable collinearity via **Principal Component Analysis (PCA)**.  
- Runs **distance-based Redundancy Analysis (db-RDA)** using soil **PCs as predictors**.  
- Applies **permutation tests blocked by sampling time**.  
- Fits original soil variables using **envfit** for **visual interpretation only**.  
- Produces a **db-RDA ordination biplot**.  
- **Output:** Excel tables (VIF, PCA loadings, db-RDA statistics) and db-RDA figure in `results/`. 

### **06_ANCOMBC2.R**
- Runs **ANCOM-BC2** differential abundance testing (*Organic vs. Conventional*).  
- Analysis at family level.  
- Outputs **log2 fold change** and **relative abundance plots**.  
- **Output:** Excel tables and PDF figures in `results/`.  



## **Usage Instructions**

1. Place all required input files in the **`data/`** folder.  
2. Run the scripts sequentially (**01 → 06**) inside the **`scripts/`** directory.  
3. Outputs (tables/figures) will be automatically saved in the **`results/`** folder.  
4. Each script can also be executed independently if necessary.  


## Dependencies

- **R version ≥ 4.2**  

Required **R packages**:  
`phyloseq`, `vegan`, `ggplot2`, `dplyr`, `tidyr`, `patchwork`, `rstatix`,  
`ggsignif`, `writexl`, `openxlsx`, `ANCOMBC`, `mia`, `Biostrings`  

Install with:  

```r
install.packages(c(
  "phyloseq", "vegan", "ggplot2", "dplyr", "tidyr", 
  "patchwork", "rstatix", "ggsignif", "writexl", "openxlsx"
))
BiocManager::install(c("ANCOMBC", "mia", "Biostrings"))
```
-This repository does not include raw preprocessing (quality filtering, denoising, chimera removal). That step is handled by Raw-to-Rawr-SLURM with DADA2 and taxonomy assignment using SILVA (16S) or UNITE (ITS).

---
Author

Blanca Ruiz 
