
# Title: Import and initial filtering of amplicon data (16S/ITS)
# Description: Creates a phyloseq object from OTU/ASV counts, taxonomy,
#              metadata, and reference sequences. Applies marker-specific
#              filters (16S: chloroplast, mitochondria).
# Author: Blanca Ruiz


# Load libraries
library(phyloseq)
library(Biostrings)


# 1) Define input files (edit paths as needed)

features_file <- "data/otu_table.RDS"
taxonomy_file <- "data/tax_table.RDS"
metadata_file <- "data/metadata.csv"
refseq_file   <- "data/refseq.fasta"   # set to NULL if not available

marker <- "16S"                   # or "ITS"
min_abundance <- 10
output_file <- "results/soil_clean.rds"

# Optional: load R environment if generated by Picasso
# load("data/Renvironment.RData")

# Ensure output folder exists
if (!dir.exists("results")) dir.create("results", recursive = TRUE)


# 2) Load input data

otu_mat  <- readRDS(features_file)
tax_mat  <- readRDS(taxonomy_file)

metadata <- tryCatch(
  read.csv(metadata_file, sep = ";", row.names = 1, encoding = "UTF-8"),
  error = function(e) read.csv(metadata_file, sep = ";", row.names = 1)
)

# Optional: clean sample IDs if they carry read suffixes (Picasso outputs)
# rownames(otu_mat) <- gsub("\\.raw_1\\.fq\\.gz$", "", rownames(otu_mat), ignore.case = TRUE)

# Optional refseq
refseq <- NULL
if (!is.null(refseq_file) && file.exists(refseq_file)) {
  refseq <- readDNAStringSet(refseq_file, format = "fasta")
}

# Ensure taxa are rows (phyloseq expects taxa rows when taxa_are_rows = TRUE)
otu_mat <- t(otu_mat)

# Align samples between counts and metadata
common_samples <- intersect(colnames(otu_mat), rownames(metadata))
if (length(common_samples) == 0) stop("No overlapping sample IDs between counts and metadata.")
otu_mat <- otu_mat[, common_samples, drop = FALSE]
metadata <- metadata[common_samples, , drop = FALSE]

# Convert character columns in metadata to factors
metadata[] <- lapply(metadata, function(x) if (is.character(x)) factor(x) else x)

# Build phyloseq object
soil_ps <- phyloseq(
  otu_table(as.matrix(otu_mat), taxa_are_rows = TRUE),
  sample_data(metadata),
  tax_table(as.matrix(tax_mat)),
  refseq = refseq
)


# 3) Filtering

# Step 1: Remove low-abundance ASVs (total counts across all samples)
soil_clean <- prune_taxa(taxa_sums(soil_ps) >= min_abundance, soil_ps)

# Step 2: Remove unassigned Phylum (robust to NA and empty strings)
soil_clean <- subset_taxa(
  soil_clean,
  !is.na(Phylum) & Phylum != "" & Phylum != "NA"
)

# Step 3: Marker-specific filtering
if (toupper(marker) == "16S") {
  soil_clean <- subset_taxa(
    soil_clean,
    (is.na(Family) | Family != "Mitochondria") &
      (is.na(Class)  | Class  != "Chloroplast")
  )
}
# For ITS, no marker-specific filtering is applied.

# Step 4: Drop zero-count ASVs after filtering
soil_clean <- prune_taxa(taxa_sums(soil_clean) > 0, soil_clean)

# Summary output
cat("Marker:", marker, "\n")
cat("Number of ASVs retained:", ntaxa(soil_clean), "\n")


# 4) Save results

saveRDS(soil_clean, file = output_file)
cat("Saved filtered phyloseq object to:", output_file, "\n")
